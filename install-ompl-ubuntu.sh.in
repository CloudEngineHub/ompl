#!/bin/bash

set -e

if [ `id -u` == 0 ]; then
    export SUDO=
    export DEBIAN_FRONTEND=noninteractive
    export PIP_ARGS=--break-system-packages
else
    SUDO="sudo -H"
fi

install_common_dependencies()
{
    # install most dependencies via apt-get
    ${SUDO} apt-get -y update && \
    ${SUDO} apt-get -y install \
        clang \
        cmake \
        libboost-filesystem-dev \
        libboost-program-options-dev \
        libboost-serialization-dev \
        libboost-system-dev \
        libboost-test-dev \
        libeigen3-dev \
        libexpat1 \
        libtriangle-dev \
        ninja-build \
        pkg-config \
        wget
    export CXX=clang++
}

install_python_binding_dependencies()
{
    ${SUDO} apt-get -y install python3-dev
}

install_ompl()
{
    wget -O - https://github.com/ompl/ompl/archive/@PROJECT_VERSION@.tar.gz | tar zxf -
    cd ompl-@PROJECT_VERSION@
    cmake \
        -G Ninja \
        -B build \
        -DPYTHON_EXECUTABLE=/usr/bin/python3 \
        -DOMPL_REGISTRATION=OFF \
        -DCMAKE_INSTALL_PREFIX=/usr && \
    cmake --build build && \
    ${SUDO} cmake --install build
}

for i in "$@"
do
case $i in
    -p|--python)
        PYTHON=1
        shift
        ;;
    *)
        # unknown option -> show help
        echo "Usage: `basename $0` [-p] [-a]"
        echo "  -p: enable Python bindings"
    ;;
esac
done

install_common_dependencies
if [ ! -z $PYTHON ]; then
    install_python_binding_dependencies
fi
install_ompl
